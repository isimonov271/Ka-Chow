<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (—Å—Ç–æ–ª–±–µ—Ü A –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ J)</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; cursor: default; }
th { background: #eee; }
td { cursor: pointer; }
td input { width: 100%; box-sizing: border-box; }
button { margin-top: 10px; padding: 8px 12px; }
</style>
</head>
<body>
<h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (—Å—Ç–æ–ª–±–µ—Ü A –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ J)</h2>

<table id="equipTable">
  <thead></thead>
  <tbody></tbody>
</table>

<button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzNAPgzWHb_D_RF9Zrjrd894yduIETtzQCyMemoZs-zzkMYBqqWFlETuDke3QCu3reqOg/exec";
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR3bKUFvSQgLei3Zi4bzfuxZBw500l1-AEOnYc0s-Gka7Ca_IkKjMllqM9rzj6Q7ZR_ilxDVE2597n/pub?output=csv";

let tableData = [];
let changes = [];

// –∑–∞–≥—Ä—É–∂–∞–µ–º CSV —á–µ—Ä–µ–∑ PapaParse
Papa.parse(csvURL, {
    download: true,
    header: false,
    complete: function(results) {
        tableData = results.data;
        renderTable();
    }
});

function renderTable() {
    const thead = document.querySelector("#equipTable thead");
    const tbody = document.querySelector("#equipTable tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    // –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü A)
    const trHead = document.createElement("tr");
    tableData[0].slice(1).forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    // —Å—Ç—Ä–æ–∫–∏
    for (let r = 1; r < tableData.length; r++) {
        const tr = document.createElement("tr");
        // –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏, –∫—Ä–æ–º–µ A (0)
        const colsToShow = [...Array(tableData[r].length).keys()].filter(i => i !== 0);
        colsToShow.forEach(colIndex => {
            const td = document.createElement("td");
            td.textContent = tableData[r][colIndex];
            td.addEventListener("click", () => makeEditable(td, r, colIndex));
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
}

function makeEditable(td, row, col) {
    const oldVal = td.textContent;
    td.innerHTML = <input type="text" value="${oldVal}">;
    const input = td.querySelector("input");
    input.focus();
    input.addEventListener("blur", () => {
        const newVal = input.value;
        td.textContent = newVal;
        tableData[row][col] = newVal;

        const exist = changes.find(ch => ch.row===row && ch.col===col);
        if (exist) {
            exist.value = newVal;
        } else {
            changes.push({row: row, col: col, value: newVal});
        }
    });
}

// —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
document.getElementById("saveBtn").addEventListener("click", () => {
    if (changes.length === 0) {
        alert("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
        return;
    }

    fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(changes)
    })
    .then(r => r.text())
    .then(msg => {
        alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        changes = [];
    });
});
</script>
</body>
</html>
