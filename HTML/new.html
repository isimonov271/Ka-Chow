<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; cursor: default; }
    th { background: #eee; cursor: pointer; }
    th.sorted-asc::after { content: " ‚ñ≤"; }
    th.sorted-desc::after { content: " ‚ñº"; }
    td { cursor: pointer; }
    td input { width: 100%; box-sizing: border-box; }
    input, select { margin-left: 10px; padding: 5px; }
    button { margin-top: 10px; padding: 8px 12px; }
    td.edited { background: #ffffcc; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h2>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h2>

  <label for="statusFilter">–°—Ç–∞—Ç—É—Å: </label>
  <select id="statusFilter">
    <option value="–í—Å–µ">–í—Å–µ</option>
    <option value="–ó–∞–Ω—è—Ç–æ">–ó–∞–Ω—è—Ç–æ</option>
    <option value="–°–≤–æ–±–æ–¥–Ω–æ">–°–≤–æ–±–æ–¥–Ω–æ</option>
  </select>

  <label for="typeFilter" style="margin-left:20px;">–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: </label>
  <select id="typeFilter">
    <option value="–í—Å–µ">–í—Å–µ</option>
  </select>

  <label for="searchText" style="margin-left:20px;">–ü–æ–∏—Å–∫: </label>
  <input type="text" id="searchText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...">

  <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

  <table id="equipTable">
    <thead></thead>
    <tbody></tbody>
  </table>

<script>
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR3bKUFvSQgLei3Zi4bzfuxZBw500l1-AEOnYc0s-Gka7Ca_IkKjMllqM9rzj6Q7ZR_ilxDVE2597n/pub?output=csv";
const scriptURL = "https://script.google.com/macros/s/AKfycbzNAPgzWHb_D_RF9Zrjrd894yduIETtzQCyMemoZs-zzkMYBqqWFlETuDke3QCu3reqOg/exec";

let allData = [];
let sortConfig = { col: null, dir: 1 };
let changes = [];

// –ò–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–æ–ª–±–µ—Ü A, –∏–Ω–¥–µ–∫—Å 0)
const visibleCols = [...Array(10).keys()].filter(i => i!==0); // 0..9, –∫—Ä–æ–º–µ 0

// –∑–∞–≥—Ä—É–∑–∫–∞ CSV
Papa.parse(csvURL, {
  download: true,
  header: false,
  complete: function(results) {
    allData = results.data;
    fillTypeFilter();
    renderTable("–í—Å–µ","–í—Å–µ","");
  }
});

// –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ç–∏–ø—É
function fillTypeFilter() {
  const typeSet = new Set();
  allData.slice(1).forEach(row => { if(row[1]) typeSet.add(row[1].trim()); }); // B (–∏–Ω–¥–µ–∫—Å 1) –∫–∞–∫ —Ç–∏–ø
  const select = document.getElementById("typeFilter");
  typeSet.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });
}

function renderTable(statusFilter, typeFilter, searchText) {
  const tbody = document.querySelector("#equipTable tbody");
  const thead = document.querySelector("#equipTable thead");
  tbody.innerHTML = "";
  thead.innerHTML = "";

  // –∑–∞–≥–æ–ª–æ–≤–∫–∏
  const trHead = document.createElement("tr");
  visibleCols.forEach(idx => {
    const th = document.createElement("th");
    th.textContent = allData[0][idx];
    th.addEventListener("click", () => {
      if(sortConfig.col===idx){ sortConfig.dir*=-1; } else { sortConfig.col=idx; sortConfig.dir=1; }
      applyFilters();
    });
    if(sortConfig.col===idx) th.classList.add(sortConfig.dir===1?"sorted-asc":"sorted-desc");
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  // —Ñ–∏–ª—å—Ç—Ä –∏ –ø–æ–∏—Å–∫
  const search = searchText.toLowerCase();
  const filtered = allData.slice(1).filter(row=>{
    const status = row[8]?.trim(); // H/I? –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å 8 (—Å—Ç–æ–ª–±–µ—Ü H) –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
    const type = row[1]?.trim(); // B –∫–∞–∫ —Ç–∏–ø
    const rowText = visibleCols.map(i=>row[i]?row[i].toString().toLowerCase():"").join(" ");
    const matchSearch = search==="" || rowText.includes(search);
    return (statusFilter==="–í—Å–µ"||status===statusFilter)&&(typeFilter==="–í—Å–µ"||type===typeFilter)&&matchSearch;
  });

  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  if(sortConfig.col!==null){
    filtered.sort((a,b)=>{
      let valA=a[sortConfig.col]??"", valB=b[sortConfig.col]??"";let numA=parseFloat(valA.toString().replace(",",".")), numB=parseFloat(valB.toString().replace(",",".")); 
      if(!isNaN(numA)&&!isNaN(numB)) return (numA-numB)*sortConfig.dir;
      return valA.toString().localeCompare(valB.toString())*sortConfig.dir;
    });
  }

  // —Å—Ç—Ä–æ–∫–∏
  filtered.forEach((row,ridx)=>{
    const tr=document.createElement("tr");
    visibleCols.forEach(idx=>{
      const td=document.createElement("td");
      td.textContent=row[idx]??"";
      td.addEventListener("click",()=>makeEditable(td,allData.indexOf(row),idx));
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function makeEditable(td,row,col){
  const oldVal = td.textContent;
  td.innerHTML = <input type="text" value="${oldVal}">;
  const input = td.querySelector("input");
  input.focus();
  input.addEventListener("blur", ()=>{
    const newVal=input.value;
    td.textContent=newVal;
    td.classList.add("edited");
    allData[row][col]=newVal;
    const exist = changes.find(c=>c.row===row && c.col===col);
    if(exist){ exist.value=newVal; } else { changes.push({row,col,value:newVal}); }
  });
}

function applyFilters(){
  renderTable(document.getElementById("statusFilter").value,
              document.getElementById("typeFilter").value,
              document.getElementById("searchText").value);
}

document.getElementById("statusFilter").addEventListener("change",applyFilters);
document.getElementById("typeFilter").addEventListener("change",applyFilters);
document.getElementById("searchText").addEventListener("input",applyFilters);

document.getElementById("saveBtn").addEventListener("click",()=>{
  if(changes.length===0){ alert("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!"); return; }
  fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify(changes)
  }).then(r=>r.text()).then(msg=>{
    alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    changes=[];
    document.querySelectorAll("td.edited").forEach(td=>td.classList.remove("edited"));
  });
});
</script>
</body>
</html>
