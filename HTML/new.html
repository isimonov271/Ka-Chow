<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Фильтр оборудования</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { color: #226e93; text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; vertical-align: middle; text-align: center; cursor: default; }
    th { background: #eee; cursor: pointer; }
    th.sorted-asc::after { content: " ▲"; }
    th.sorted-desc::after { content: " ▼"; }
    input, select { margin-left: 10px; padding: 5px; }
    button { margin-left: 10px; padding: 5px; }
    .back-home-btn { margin-right: 10px; }
  </style>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h2>Оборудование НМК</h2>

  <button onclick="window.location.href='index.html'" class="back-home-btn">На главную</button>

  <label for="statusFilter">Статус: </label>
  <select id="statusFilter">
    <option value="Все">Все</option>
    <option value="Занято">Занято</option>
    <option value="Свободно">Свободно</option>
  </select>

  <label for="typeFilter" style="margin-left:20px;">Тип оборудования: </label>
  <select id="typeFilter">
    <option value="Все">Все</option>
  </select>

  <label for="searchText" style="margin-left:20px;">Поиск по всем колонкам: </label>
  <input type="text" id="searchText" placeholder="Введите текст...">

  <button onclick="resetFiltersAndSorting()">Сбросить фильтрацию и сортировку</button>

  <table id="equipTable">
    <thead>
      <tr>
        <th data-col="0">Тип</th>
        <th data-col="1">Описание</th>
        <th data-col="2">Стоимость</th>
        <th data-col="3">Кол-во</th>
        <th data-col="4">В работе</th>
        <th data-col="5">Занято по иным причинам</th>
        <th data-col="6">Свободно</th>
        <th data-col="7">Статус</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR3bKUFvSQgLei3Zi4bzfuxZBw500l1-AEOnYc0s-Gka7Ca_IkKjMllqM9rzj6Q7ZR_ilxDVE2597n/pub?output=csv";

let allData = [];
// нужные колонки: A,B,D,E,F,G,H,I
const neededCols = [0,1,3,4,5,6,7,8];
let sortConfig = { col: null, dir: 1 };

Papa.parse(url, {
  download: true,
  header: false,
  complete: function(results) {
    allData = results.data.slice(1);
    fillTypeFilter();
    renderTable("Все","Все","");
  }
});

function fillTypeFilter() {
  const typeSet = new Set();
  allData.forEach(row => {
    if (row[0]) typeSet.add(row[0].trim());
  });
  const select = document.getElementById("typeFilter");
  typeSet.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });
}

function renderTable(statusFilter, typeFilter, searchText) {
  const tbody = document.querySelector("#equipTable tbody");
  tbody.innerHTML = "";
  const search = searchText.toLowerCase();

  let filtered = allData.filter(row => {
    const status = row[7]?.trim();
    const type   = row[0]?.trim();
    const rowText = neededCols.map(idx => row[idx] ? row[idx].toString().toLowerCase() : "").join(" ");
    const matchSearch = search === "" || rowText.includes(search);

    return (statusFilter === "Все" || status === statusFilter) &&
           (typeFilter === "Все" || type === typeFilter) &&
           matchSearch;
  });

  // сортировка
  if (sortConfig.col !== null) {
    filtered.sort((a,b) => {
      let valA = a[neededCols[sortConfig.col]] ?? "";
      let valB = b[neededCols[sortConfig.col]] ?? "";

      let numA = parseFloat(valA.toString().replace(",","."));
      let numB = parseFloat(valB.toString().replace(",","."));
      if (!isNaN(numA) && !isNaN(numB)) {
        return (numA - numB) * sortConfig.dir;
      }
      return valA.toString().localeCompare(valB.toString()) * sortConfig.dir;
    });
  }

  filtered.forEach(row => {
    const tr = document.createElement("tr");
    neededCols.forEach(idx => {
      const td = document.createElement("td");
      td.textContent = row[idx] ?? "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  document.querySelectorAll("#equipTable th").forEach((th,i) => {
    th.classList.remove("sorted-asc","sorted-desc");
    if (i === sortConfig.col) {
      th.classList.add(sortConfig.dir === 1 ? "sorted-asc" : "sorted-desc");
    }
  });
}

function resetFiltersAndSorting() {
  document.getElementById("statusFilter").value = "Все";
  document.getElementById("typeFilter").value = "Все";
  document.getElementById("searchText").value = "";
  sortConfig = { col: null, dir: 1 };
  renderTable("Все","Все","");
}

function applyFilters() {
  renderTable(
    document.getElementById("statusFilter").value,
    document.getElementById("typeFilter").value,
    document.getElementById("searchText").value
  );
}

document.getElementById("statusFilter").addEventListener("change", applyFilters);
document.getElementById("typeFilter").addEventListener("change", applyFilters);
document.getElementById("searchText").addEventListener("input", applyFilters);

document.querySelectorAll("#equipTable th").forEach((th,i) => {
  th.addEventListener("click", () => {
    if (sortConfig.col === i) {
      sortConfig.dir *= -1;
    } else {
      sortConfig.col = i;
      sortConfig.dir = 1;
    }
    applyFilters();
  });
});
</script>
</body>
</html>
