<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Фильтр оборудования</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { color: #226e93; text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; vertical-align: middle; text-align: center; cursor: default; }
    th { background: #eee; cursor: pointer; }
    th.sorted-asc::after { content: " ▲"; }
    th.sorted-desc::after { content: " ▼"; }
    input, select { margin-left: 10px; padding: 5px; }
    button { margin-left: 10px; padding: 5px; }
    .back-home-btn { margin-right: 10px; }
  </style>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h2>Оборудование НМК ТС</h2>

  <button onclick="window.location.href='index.html'" class="back-home-btn">На главную</button>

  <label for="statusFilter">Статус: </label>
  <select id="statusFilter">
    <option value="Все">Все</option>
    <option value="Занято">Занято</option>
    <option value="Свободно">Свободно</option>
  </select>

  <label for="typeFilter" style="margin-left:20px;">Тип оборудования: </label>
  <select id="typeFilter">
    <option value="Все">Все</option>
  </select>

  <label for="searchText" style="margin-left:20px;">Поиск по всем колонкам: </label>
  <input type="text" id="searchText" placeholder="Введите текст...">

  <button onclick="resetFiltersAndSorting()">Сбросить фильтр</button>

  <table id="equipTable">
    <thead>
      <tr>
        <th data-col="1">Тип</th>
        <th data-col="2">Описание</th>
        <th data-col="3">Стоимость</th>
        <th data-col="4">Кол-во</th>
        <th data-col="5">В работе</th>
        <th data-col="6">Занято иначе</th>
        <th data-col="7">Свободно</th>
        <th data-col="8">Статус</th>
        <th data-col="9">Комментарий</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR3bKUFvSQgLei3Zi4bzfuxZBw500l1-AEOnYc0s-Gka7Ca_IkKjMllqM9rzj6Q7ZR_ilxDVE2597n/pub?output=csv";

let allData = [];
// Нужные колонки: B,C,D,E,F,G,H,I,J
const neededCols = [1,2,3,4,5,6,7,8,9]; // Колонки с первого листа Google Sheets
let sortConfig = { col: null, dir: 1 }; // Настройки сортировки

Papa.parse(url, {
  download: true,
  header: false,
  complete: function(results) {
    allData = results.data.slice(1); // Пропускаем первую строку с заголовком
    fillTypeFilter(); // Заполняем выпадающее меню типов оборудования
    renderTable("Все","Все",""); // Первоначальная загрузка данных
  }
});

// Заполнение списка типов оборудования
function fillTypeFilter() {
  const typeSet = new Set();
  allData.forEach(row => {
    if (row[1]) typeSet.add(row[1].trim()); // Тип оборудования находится в первой колонке (индекс 1)
  });
  const select = document.getElementById("typeFilter");
  typeSet.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });
}

// Рендеринг таблицы
function renderTable(statusFilter, typeFilter, searchText) {
  const tbody = document.querySelector("#equipTable tbody");
  tbody.innerHTML = "";
  const search = searchText.toLowerCase();

  let filtered = allData.filter(row => {
    const status = row[8]?.trim(); // Статус находится в 9-й колонке (индекс 8)
    const type   = row[1]?.trim(); // Тип оборудования находится в 2-й колонке (индекс 1)
    const rowText = neededCols.map(idx => row[idx] ? row[idx].toString().toLowerCase() : "").join(" "); // Поиск по нужным колонкам
    const matchSearch = search === "" || rowText.includes(search);
    
    return (statusFilter === "Все" || status === statusFilter) &&
           (typeFilter === "Все" || type === typeFilter) &&
           matchSearch;
  });

  // Сортируем таблицу
  if (sortConfig.col !== null) {
    filtered.sort((a,b) => {
      let valA = a[neededCols[sortConfig.col]] ?? "";
      let valB = b[neededCols[sortConfig.col]] ?? "";
      
      // Если данные являются числами, сортируем численно
      let numA = parseFloat(valA.replace(",", "."));
      let numB = parseFloat(valB.replace(",", "."));
      if (!isNaN(numA) && !isNaN(numB)) {
        return (numA - numB) * sortConfig.dir;
      }
      // Иначе сортируем лексикографически
      return valA.localeCompare(valB) * sortConfig.dir;
    });
  }

  // Отображаем данные
  filtered.forEach(row => {
    const tr = document.createElement("tr");
    neededCols.forEach(idx => {
      const td = document.createElement("td");
      td.textContent = row[idx] ?? "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Обновляем иконки сортировки
  document.querySelectorAll("#equipTable th").forEach((th,i) => {
    th.classList.remove("sorted-asc","sorted-desc");
    if (i === sortConfig.col) {
      th.classList.add(sortConfig.dir === 1 ? "sorted-asc" : "sorted-desc");
    }
  });
}

// Функция сброса фильтров и сортировки
function resetFiltersAndSorting() {
  document.getElementById("statusFilter").value = "Все";
  document.getElementById("typeFilter").value = "Все";
  document.getElementById("searchText").value = "";
  sortConfig = { col: null, dir: 1 };
  renderTable("Все","Все","");
}

// Применение фильтров
function applyFilters() {
  renderTable(
    document.getElementById("statusFilter").value,
    document.getElementById("typeFilter").value,
    document.getElementById("searchText").value
  );
}

// Подписываем события на изменение фильтров
document.getElementById("statusFilter").addEventListener("change", applyFilters);
document.getElementById("typeFilter").addEventListener("change", applyFilters);
document.getElementById("searchText").addEventListener("input", applyFilters);

// Добавляем событие сортировки по клику на заголовки колонок
document.querySelectorAll("#equipTable th").forEach((th,i) => {
  th.addEventListener("click", () => {
    if (sortConfig.col === i) {
      sortConfig.dir *= -1; // Меняем направление сортировки
    } else {
      sortConfig.col = i; // Устанавливаем новую колонку для сортировки
      sortConfig.dir = 1; // Начинаем с восходящей сортировки
    }
    applyFilters(); // Перезагружаем таблицу с новыми настройками
  });
});
</script>
</body>
</html>
